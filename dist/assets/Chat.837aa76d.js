import{ag as I,ah as g,ai as fe,aj as ee,ak as pe,al as T,am as x,an as J,ao as A,ap as ge,aq as P,o as c,n as f,a4 as X,ar as ve,f as o,F as E,t as W,a1 as ce,a2 as me,x as _,a as l,w as n,O as _e,as as be,a5 as $,at as ye,ab as Ce,l as b,au as B,av as O,aw as K,ax as U,ay as Ie,az as Me,aA as we,aB as Se,aC as De,aD as Le,q as L,c as F,b as te,e as ae,g as k,D,k as j,aE as H,i as V,s as Te,aF as se,P as xe,M as Ae,A as Pe,aG as Fe,T as oe,aH as le,aI as ke,d as re,aJ as Ve,aK as Ne,K as Ee,aL as Q,a0 as ie,aM as Re,L as N,p as Be}from"./index.55ede2bf.js";import{_ as Oe}from"./BaseLeftRightPart.53d3f799.js";import{_ as q}from"./plugin-vue_export-helper.21dcd24c.js";function z(e,t){I(2,arguments);var s=g(e),u=g(t),a=s.getTime()-u.getTime();return a<0?-1:a>0?1:a}function Ue(e,t){I(2,arguments);var s=g(e),u=g(t),a=s.getFullYear()-u.getFullYear(),r=s.getMonth()-u.getMonth();return a*12+r}function je(e,t){return I(2,arguments),g(e).getTime()-g(t).getTime()}var ne={ceil:Math.ceil,round:Math.round,floor:Math.floor,trunc:function(e){return e<0?Math.ceil(e):Math.floor(e)}},He="trunc";function We(e){return e?ne[e]:ne[He]}function ze(e){I(1,arguments);var t=g(e);return t.setHours(23,59,59,999),t}function Xe(e){I(1,arguments);var t=g(e),s=t.getMonth();return t.setFullYear(t.getFullYear(),s+1,0),t.setHours(23,59,59,999),t}function qe(e){I(1,arguments);var t=g(e);return ze(t).getTime()===Xe(t).getTime()}function Ye(e,t){I(2,arguments);var s=g(e),u=g(t),a=z(s,u),r=Math.abs(Ue(s,u)),i;if(r<1)i=0;else{s.getMonth()===1&&s.getDate()>27&&s.setDate(30),s.setMonth(s.getMonth()-a*r);var y=z(s,u)===-a;qe(g(e))&&r===1&&z(e,u)===1&&(y=!1),i=a*(r-Number(y))}return i===0?0:i}function Ge(e,t,s){I(2,arguments);var u=je(e,t)/1e3;return We(s==null?void 0:s.roundingMethod)(u)}function he(e,t){if(e==null)throw new TypeError("assign requires that input parameter not be null or undefined");for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s]);return e}function Je(e){return he({},e)}var de=1440,Ke=2520,Z=43200,Qe=86400;function Ze(e,t,s){var u,a;I(2,arguments);var r=pe(),i=(u=(a=s==null?void 0:s.locale)!==null&&a!==void 0?a:r.locale)!==null&&u!==void 0?u:fe;if(!i.formatDistance)throw new RangeError("locale must contain formatDistance property");var y=z(e,t);if(isNaN(y))throw new RangeError("Invalid time value");var m=he(Je(s),{addSuffix:Boolean(s==null?void 0:s.addSuffix),comparison:y}),w,S;y>0?(w=g(t),S=g(e)):(w=g(e),S=g(t));var M=Ge(S,w),d=(ee(S)-ee(w))/1e3,h=Math.round((M-d)/60),C;if(h<2)return s!=null&&s.includeSeconds?M<5?i.formatDistance("lessThanXSeconds",5,m):M<10?i.formatDistance("lessThanXSeconds",10,m):M<20?i.formatDistance("lessThanXSeconds",20,m):M<40?i.formatDistance("halfAMinute",0,m):M<60?i.formatDistance("lessThanXMinutes",1,m):i.formatDistance("xMinutes",1,m):h===0?i.formatDistance("lessThanXMinutes",1,m):i.formatDistance("xMinutes",h,m);if(h<45)return i.formatDistance("xMinutes",h,m);if(h<90)return i.formatDistance("aboutXHours",1,m);if(h<de){var R=Math.round(h/60);return i.formatDistance("aboutXHours",R,m)}else{if(h<Ke)return i.formatDistance("xDays",1,m);if(h<Z){var v=Math.round(h/de);return i.formatDistance("xDays",v,m)}else if(h<Qe)return C=Math.round(h/Z),i.formatDistance("aboutXMonths",C,m)}if(C=Ye(S,w),C<12){var p=Math.round(h/Z);return i.formatDistance("xMonths",p,m)}else{var Y=C%12,G=Math.floor(C/12);return Y<3?i.formatDistance("aboutXYears",G,m):Y<9?i.formatDistance("overXYears",G,m):i.formatDistance("almostXYears",G+1,m)}}var ue={list(e={sort:"name",order:"1"}){return T.get(x.DASHBOARD_BASE_URL+"/api/messages",{params:e})},listByChat(e={sort:"name",order:"1"}){return T.get(x.DASHBOARD_BASE_URL+"/api/messages/list-by-chat",{params:e})},update(e,t){return T.put(x.DASHBOARD_BASE_URL+`/api/messages/${e}`,t)},create(e){return T.post(x.DASHBOARD_BASE_URL+"/api/messages",e)},delete(e){return T.delete(x.DASHBOARD_BASE_URL+`/api/messages/${e}`)}},$e={lessThanXSeconds:{one:"menos de un segundo",other:"menos de {{count}} segundos"},xSeconds:{one:"1 segundo",other:"{{count}} segundos"},halfAMinute:"medio minuto",lessThanXMinutes:{one:"menos de un minuto",other:"menos de {{count}} minutos"},xMinutes:{one:"1 minuto",other:"{{count}} minutos"},aboutXHours:{one:"alrededor de 1 hora",other:"alrededor de {{count}} horas"},xHours:{one:"1 hora",other:"{{count}} horas"},xDays:{one:"1 d\xEDa",other:"{{count}} d\xEDas"},aboutXWeeks:{one:"alrededor de 1 semana",other:"alrededor de {{count}} semanas"},xWeeks:{one:"1 semana",other:"{{count}} semanas"},aboutXMonths:{one:"alrededor de 1 mes",other:"alrededor de {{count}} meses"},xMonths:{one:"1 mes",other:"{{count}} meses"},aboutXYears:{one:"alrededor de 1 a\xF1o",other:"alrededor de {{count}} a\xF1os"},xYears:{one:"1 a\xF1o",other:"{{count}} a\xF1os"},overXYears:{one:"m\xE1s de 1 a\xF1o",other:"m\xE1s de {{count}} a\xF1os"},almostXYears:{one:"casi 1 a\xF1o",other:"casi {{count}} a\xF1os"}},et=function(e,t,s){var u,a=$e[e];return typeof a=="string"?u=a:t===1?u=a.one:u=a.other.replace("{{count}}",t.toString()),s!=null&&s.addSuffix?s.comparison&&s.comparison>0?"en "+u:"hace "+u:u},tt=et,at={full:"EEEE, d 'de' MMMM 'de' y",long:"d 'de' MMMM 'de' y",medium:"d MMM y",short:"dd/MM/y"},st={full:"HH:mm:ss zzzz",long:"HH:mm:ss z",medium:"HH:mm:ss",short:"HH:mm"},ot={full:"{{date}} 'a las' {{time}}",long:"{{date}} 'a las' {{time}}",medium:"{{date}}, {{time}}",short:"{{date}}, {{time}}"},lt={date:J({formats:at,defaultWidth:"full"}),time:J({formats:st,defaultWidth:"full"}),dateTime:J({formats:ot,defaultWidth:"full"})},rt=lt,it={lastWeek:"'el' eeee 'pasado a la' p",yesterday:"'ayer a la' p",today:"'hoy a la' p",tomorrow:"'ma\xF1ana a la' p",nextWeek:"eeee 'a la' p",other:"P"},nt={lastWeek:"'el' eeee 'pasado a las' p",yesterday:"'ayer a las' p",today:"'hoy a las' p",tomorrow:"'ma\xF1ana a las' p",nextWeek:"eeee 'a las' p",other:"P"},dt=function(e,t,s,u){return t.getUTCHours()!==1?nt[e]:it[e]},ut=dt,ct={narrow:["AC","DC"],abbreviated:["AC","DC"],wide:["antes de cristo","despu\xE9s de cristo"]},mt={narrow:["1","2","3","4"],abbreviated:["T1","T2","T3","T4"],wide:["1\xBA trimestre","2\xBA trimestre","3\xBA trimestre","4\xBA trimestre"]},ht={narrow:["e","f","m","a","m","j","j","a","s","o","n","d"],abbreviated:["ene","feb","mar","abr","may","jun","jul","ago","sep","oct","nov","dic"],wide:["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"]},ft={narrow:["d","l","m","m","j","v","s"],short:["do","lu","ma","mi","ju","vi","s\xE1"],abbreviated:["dom","lun","mar","mi\xE9","jue","vie","s\xE1b"],wide:["domingo","lunes","martes","mi\xE9rcoles","jueves","viernes","s\xE1bado"]},pt={narrow:{am:"a",pm:"p",midnight:"mn",noon:"md",morning:"ma\xF1ana",afternoon:"tarde",evening:"tarde",night:"noche"},abbreviated:{am:"AM",pm:"PM",midnight:"medianoche",noon:"mediodia",morning:"ma\xF1ana",afternoon:"tarde",evening:"tarde",night:"noche"},wide:{am:"a.m.",pm:"p.m.",midnight:"medianoche",noon:"mediodia",morning:"ma\xF1ana",afternoon:"tarde",evening:"tarde",night:"noche"}},gt={narrow:{am:"a",pm:"p",midnight:"mn",noon:"md",morning:"de la ma\xF1ana",afternoon:"de la tarde",evening:"de la tarde",night:"de la noche"},abbreviated:{am:"AM",pm:"PM",midnight:"medianoche",noon:"mediodia",morning:"de la ma\xF1ana",afternoon:"de la tarde",evening:"de la tarde",night:"de la noche"},wide:{am:"a.m.",pm:"p.m.",midnight:"medianoche",noon:"mediodia",morning:"de la ma\xF1ana",afternoon:"de la tarde",evening:"de la tarde",night:"de la noche"}},vt=function(e,t){var s=Number(e);return s+"\xBA"},_t={ordinalNumber:vt,era:A({values:ct,defaultWidth:"wide"}),quarter:A({values:mt,defaultWidth:"wide",argumentCallback:function(e){return Number(e)-1}}),month:A({values:ht,defaultWidth:"wide"}),day:A({values:ft,defaultWidth:"wide"}),dayPeriod:A({values:pt,defaultWidth:"wide",formattingValues:gt,defaultFormattingWidth:"wide"})},bt=_t,yt=/^(\d+)(º)?/i,Ct=/\d+/i,It={narrow:/^(ac|dc|a|d)/i,abbreviated:/^(a\.?\s?c\.?|a\.?\s?e\.?\s?c\.?|d\.?\s?c\.?|e\.?\s?c\.?)/i,wide:/^(antes de cristo|antes de la era com[uú]n|despu[eé]s de cristo|era com[uú]n)/i},Mt={any:[/^ac/i,/^dc/i],wide:[/^(antes de cristo|antes de la era com[uú]n)/i,/^(despu[eé]s de cristo|era com[uú]n)/i]},wt={narrow:/^[1234]/i,abbreviated:/^T[1234]/i,wide:/^[1234](º)? trimestre/i},St={any:[/1/i,/2/i,/3/i,/4/i]},Dt={narrow:/^[efmajsond]/i,abbreviated:/^(ene|feb|mar|abr|may|jun|jul|ago|sep|oct|nov|dic)/i,wide:/^(enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|octubre|noviembre|diciembre)/i},Lt={narrow:[/^e/i,/^f/i,/^m/i,/^a/i,/^m/i,/^j/i,/^j/i,/^a/i,/^s/i,/^o/i,/^n/i,/^d/i],any:[/^en/i,/^feb/i,/^mar/i,/^abr/i,/^may/i,/^jun/i,/^jul/i,/^ago/i,/^sep/i,/^oct/i,/^nov/i,/^dic/i]},Tt={narrow:/^[dlmjvs]/i,short:/^(do|lu|ma|mi|ju|vi|s[áa])/i,abbreviated:/^(dom|lun|mar|mi[ée]|jue|vie|s[áa]b)/i,wide:/^(domingo|lunes|martes|mi[ée]rcoles|jueves|viernes|s[áa]bado)/i},xt={narrow:[/^d/i,/^l/i,/^m/i,/^m/i,/^j/i,/^v/i,/^s/i],any:[/^do/i,/^lu/i,/^ma/i,/^mi/i,/^ju/i,/^vi/i,/^sa/i]},At={narrow:/^(a|p|mn|md|(de la|a las) (mañana|tarde|noche))/i,any:/^([ap]\.?\s?m\.?|medianoche|mediodia|(de la|a las) (mañana|tarde|noche))/i},Pt={any:{am:/^a/i,pm:/^p/i,midnight:/^mn/i,noon:/^md/i,morning:/mañana/i,afternoon:/tarde/i,evening:/tarde/i,night:/noche/i}},Ft={ordinalNumber:ge({matchPattern:yt,parsePattern:Ct,valueCallback:function(e){return parseInt(e,10)}}),era:P({matchPatterns:It,defaultMatchWidth:"wide",parsePatterns:Mt,defaultParseWidth:"any"}),quarter:P({matchPatterns:wt,defaultMatchWidth:"wide",parsePatterns:St,defaultParseWidth:"any",valueCallback:function(e){return e+1}}),month:P({matchPatterns:Dt,defaultMatchWidth:"wide",parsePatterns:Lt,defaultParseWidth:"any"}),day:P({matchPatterns:Tt,defaultMatchWidth:"wide",parsePatterns:xt,defaultParseWidth:"any"}),dayPeriod:P({matchPatterns:At,defaultMatchWidth:"any",parsePatterns:Pt,defaultParseWidth:"any"})},kt=Ft,Vt={code:"es",formatDistance:tt,formatLong:rt,formatRelative:ut,localize:bt,match:kt,options:{weekStartsOn:1,firstWeekContainsDate:1}},Nt=Vt;const Et={props:{telefonoId:{type:String,default:"Sin valor"}},data(){return{telefonos:[],search:""}},mounted(){this.initialize()},methods:{async initialize(){await Promise.all([this.$store.dispatch("telefonosModule/list")]),this.telefonos=this.$store.state.telefonosModule.telefonos.filter(e=>e.active==!0),this.telefonos=this.telefonos.filter(e=>e.agenteId!=null)},onSelectedAgent(e){const t=this.telefonos.find(s=>s._id==e.target.value);this.$emit("onSelectedAgent",t)}}},Rt=e=>(ce("data-v-0d489434"),e=e(),me(),e),Bt=Rt(()=>o("option",{value:"Sin valor"},"Sin agente",-1)),Ot=["value"];function Ut(e,t,s,u,a,r){return c(),f("div",null,[X(o("select",{style:{width:"auto"},onChange:t[0]||(t[0]=i=>r.onSelectedAgent(i)),"onUpdate:modelValue":t[1]||(t[1]=i=>s.telefonoId=i)},[Bt,(c(!0),f(E,null,W(a.telefonos,i=>(c(),f("option",{value:i._id,key:i._id},_(i.agenteId.nombre)+" ("+_(i.numero)+") ",9,Ot))),128))],544),[[ve,s.telefonoId]])])}var jt=q(Et,[["render",Ut],["__scopeId","data-v-0d489434"]]);const Ht={props:{initialData:{type:Array,default:()=>[]},disabled:{type:Boolean,default:!1}},data(){return{todofullLabels:[],selectedTodofullLabels:[],searchLabel:"",isInidialDataLoading:!1,isInitialDataExecuted:!1}},watch:{initialData:{handler(){!this.isInitialDataExecuted&&this.initialData.length>0&&(this.selectedTodofullLabels=this.initialData.map(e=>e._id),this.isInitialDataExecuted=!0)},immediate:!0},selectedTodofullLabels:{handler(e,t){this.searchLabel="",this.selectedTodofullLabels=this.selectedTodofullLabels.filter(s=>s),this.isInitialDataExecuted&&this.$emit("onSelectTodofullLabels",JSON.parse(JSON.stringify(this.selectedTodofullLabels)))},deep:!0}},async mounted(){this.$store.state.todofullLabelsModule.todofullLabels.length===0&&await this.$store.dispatch("todofullLabelsModule/list",{sort:"name",order:"asc"}),this.todofullLabels=this.$store.state.todofullLabelsModule.todofullLabels.map(e=>({value:e._id,title:e.name}))},methods:{async removeLabels(e,t){e.splice(e.findIndex(s=>s._id===t._id),1),this.$emit("onSelectTodofullLabels",this.selectedTodofullLabels)},getLabelTitle(e){const t=this.todofullLabels.find(s=>s.value==e);return t?t.title:""}}};function Wt(e,t,s,u,a,r){return c(),f("div",null,[l(be,{disabled:s.disabled,placeholder:"Selecciona las etiquetas",class:"mt-3","search-input":a.searchLabel,modelValue:a.selectedTodofullLabels,"onUpdate:modelValue":t[1]||(t[1]=i=>a.selectedTodofullLabels=i),items:a.todofullLabels,multiple:"","no-data-text":"No se encontraron etiquetas",outlined:"","hide-details":"true",hint:"hola que hace"},{selection:n(i=>[l(_e,{close:"","onClick:close":t[0]||(t[0]=y=>r.removeLabels(a.selectedTodofullLabels,e.item)),color:"primary"},{default:n(()=>[o("strong",null,_(r.getLabelTitle(i.selection.value)),1)]),_:2},1024)]),_:1},8,["disabled","search-input","modelValue","items"])])}var zt=q(Ht,[["render",Wt]]);const Xt={data(){return{loading:!1,nextItem:1,items:[]}},mounted(){const e=document.querySelector("#infinite-list");e.addEventListener("scroll",()=>{e.scrollTop+e.clientHeight>=e.scrollHeight&&(this.loadMore(),this.$emit("loadMore"))}),this.$emit("loadMore")},methods:{loadMore(){this.loading=!0,setTimeout(()=>{for(var e=0;e<100;e++)this.items.push("Item "+this.nextItem++);this.loading=!1},200)}}},qt=e=>(ce("data-v-02fba772"),e=e(),me(),e),Yt={class:"list-group-wrapper"},Gt={class:"loading"},Jt=qt(()=>o("span",{class:"fa fa-spinner fa-spin"},null,-1)),Kt=b(" Cargando "),Qt=[Jt,Kt],Zt={class:"list-group",id:"infinite-list"};function $t(e,t,s,u,a,r){return c(),f("div",Yt,[l(ye,{name:"fade"},{default:n(()=>[X(o("div",Gt,Qt,512),[[$,a.loading]])]),_:1}),o("ul",Zt,[o("div",null,[Ce(e.$slots,"default",{},void 0,!0)])])])}var ea=q(Xt,[["render",$t],["__scopeId","data-v-02fba772"]]);const ta={components:{BaseLeftRightPartVue:Oe,AgentsSelector:jt,TodofullLabelsSelector:zt,InfiniteScroll:ea},data(){return{activePlatforms:[],chat:null,chats:[],messages:[],selectedChat:null,text:"",isAgentConnected:!1,dialog:null,isErrorStory:!1,selectedMessage:null,search:"",fieldsToSearch:["foreign_telefono","foreign_name"],page:1,pageCount:0,chatCategories:["Pendientes","Resueltos","Todos"],formCategories:["Pendientes","Resueltos","Todos"],tabCategory:2,tabForm:0,searchContact:"",isDataReady:!1,isChatMessageReady:!1,updateLabels:0,userForm:{name:"",phone:"",email:"",city:"",notes:"",todofullLabels:[]},updateScroll:0}},mounted(){this.initialize()},methods:{async initialize(e=1){this.isDataReady=!1;let t={page:this.page||e,search:this.searchContact,fieldsToSearch:this.fieldsToSearch,sort:"updatedAt",order:"desc",limit:30};this.activePlatforms.length>0&&(t.platforms=this.activePlatforms),await Promise.all([this.$store.dispatch("botsModule/list"),this.$store.dispatch("chatsModule/list",t)]),this.chats=this.$store.state.chatsModule.chats,this.isDataReady=!0},async selectChat(e){if(this.isChatMessageReady=!1,this.selectedChat=e,this.$store.commit("chatsModule/setSelectedChat",e),this.messages=(await ue.listByChat({chatId:e._id,sort:"createdAt",order:"asc"})).data.payload,e=(await B.listOne(e._id)).data.payload,console.log("\u{1F680} Aqui *** -> chat",e),this.$store.commit("chatsModule/setMessages",this.messages),this.messages=this.$store.state.chatsModule.messages,this.chat=e,O(),this.isChatMessageReady=!0,e.leadId&&(this.userForm.name=e.leadId.sourceName||e.leadId.appName,this.userForm.email=e.leadId.email,this.userForm.city=e.leadId.city,this.userForm.todofullLabels=e.leadId.todofullLabels,this.userForm.notes=e.leadId.nota,this.userForm.phone=""),e.cleanLeadId){this.userForm.phone=e.cleanLeadId.telefono;const t=e.cleanLeadId.details.find(s=>s.fuente===e.leadId.fuente);t&&(this.userForm.name=t.nombre,this.userForm.email=t.email,this.userForm.city=t.ciudad,this.userForm.notes=t.nota),this.userForm.todofullLabels=e.cleanLeadId.todofullLabels}this.updateLabels+=1},sendTextMessage(e,t="Agente"){console.log("ENVIANDO MENSAJE: ",e,t);let s={text:e,from:t,type:"text",chatId:this.selectedChat._id,isActive:!0,createdAt:new Date};ue.create(s),this.messages.push(s),this.text="",K.emit("AGENT_MESSAGE",{senderId:this.selectedChat.leadId.contactId,chatId:this.selectedChat._id,text:e,pageID:this.selectedChat.pageID,platform:this.selectedChat.platform}),O()},connectAgent(e){if(e.isBotActive){e.isBotActive=!1,U("Chatbot desactivado correctamente");const t=JSON.parse(localStorage.getItem("user"));console.log("\u{1F680} Aqui *** -> user",t);let s="\u{1F91D}\u{1F469}\u{1F3FB}\u200D\u{1F4BC} Ahora est\xE1s conversando con el agente "+t.first_name+" "+t.last_name;console.log("CONECTANDO AGENTE"),this.sendTextMessage(s,"Chatbot"),this.isAgentConnected=!0,B.update(this.selectedChat._id,{isBotActive:!1}),O(),K.emit("CONNECT_AGENT",{senderId:this.selectedChat.leadId.contactId,chatId:this.selectedChat._id,text:s,pageID:this.selectedChat.pageID,platform:e.platform})}},endConversation(e){e.isBotActive=!0,U("Chatbot reactivado");const t=JSON.parse(localStorage.getItem("user"));let s=`El agente ${t.first_name} ${t.last_name} se ha desconectado`;this.sendTextMessage(s,"Chatbot"),this.isAgentConnected=!1,this.selectedChat.userId=null,B.update(this.selectedChat._id,{userId:null,isBotActive:!0}),K.emit("DISCONNECT_AGENT",{senderId:this.selectedChat.leadId.contactId,chatId:this.selectedChat._id,text:s,pageID:this.selectedChat.pageID,platform:e.platform})},errorStory(){this.isErrorStory=!0},loadStory(){this.isErrorStory=!1},getChatUserData(e){return Ie(e.cleanLeadId.details)},getChatUserName(e){let t=e.cleanLeadId?this.getChatUserData(e):e.leadId?e.leadId.sourceName:"Usuario";return e.leadId&&(e.leadId.sourceName||e.leadId.appName)?e.leadId.sourceName||e.leadId.appName:t?t.nombre:"Usuario"},getUserDataByPlatform(e){e.cleanLeadId.details},getPlatformIconStyle(e){return{whatsapp:"mdi-whatsapp whatsapp-color",facebook:"mdi-facebook-messenger messenger-color",instagram:"mdi-instagram instagram-color"}[e]},getProfilePic(e){if(e.leadId)return e.leadId.profile_pic},addPlatform(e){this.activePlatforms.includes(e)?this.activePlatforms=this.activePlatforms.filter(t=>t!==e):this.activePlatforms.push(e),this.initialize()},onSelectedAgent(e){this.selectedChat.cleanLeadId?(this.selectedChat.cleanLeadId.telefonoId=e,Me.update(this.selectedChat.cleanLeadId._id,{telefonoId:e._id,estado:"RE-CONECTAR"}),U("Nuevo agente asignado a lead")):(this.selectedChat.leadId.telefonoId=e,we.update(this.selectedChat.leadId._id,{telefonoId:e._id,assignAgentChat:!0}),U("Nuevo agente asignado a lead"))},onSelectTodofullLabels(e){e.length>0&&(this.userForm.todofullLabels=e)},async saveUserForm(){if(this.userForm.phone){console.log("EL PAIS: ",this.selectedChat.leadId.pais);let e=await this.$store.dispatch("cleanLeadsModule/create",{telefono:this.userForm.phone,estado:(this.selectedChat.cleanLeadId?this.selectedChat.cleanLeadId.telefonoId:null)||this.selectedChat.leadId.telefonoId?"RE-CONECTAR":"SIN ASIGNAR",telefonoId:this.selectedChat.leadId.telefonoId?this.selectedChat.leadId.telefonoId._id:null,todofullLabels:this.userForm.todofullLabels,details:[{type:"CHATBOT",contactId:this.selectedChat.leadId.contactId,fuente:this.selectedChat.leadId.fuente,appName:this.selectedChat.leadId.sourceName||this.selectedChat.leadId.appName,nombre:this.userForm.name,email:this.userForm.email,ciudad:this.userForm.city,nota:this.userForm.notes,pais:this.selectedChat.leadId.pais}]});await Promise.all([this.$store.dispatch("leadsModule/update",{id:this.selectedChat.leadId._id,data:{cleanLeadId:e._id},notifyUser:!1}),this.$store.dispatch("chatsModule/update",{id:this.selectedChat._id,data:{cleanLeadId:e._id},notifyUser:!1})])}else await this.$store.dispatch("leadsModule/update",{id:this.selectedChat.leadId._id,data:{appName:this.userForm.name,email:this.userForm.email,ciudad:this.userForm.city,nota:this.userForm.notes,todofullLabels:this.userForm.todofullLabels}})},getFileNameFromUrl(e){return Se(e)},parseMarkdown(e){return De(e)},formatDate(e,t="dd/MM/yyyy HH:mm"){return Le(e,t)},formatDateAgo(e){let t=new Date(e);return Ze(new Date,t,{addSuffix:!0,locale:Nt})},async loadMore(){console.log("CARGANDO MAS..."),this.page+=1;const e=await B.list({page:this.page,limit:10,sort:"updatedAt",order:"desc"});this.chats.push(...e.data.payload)}},computed:{filteredChats(){return this.chats},formattedMessages(){return this.messages.reduce((e,t)=>{let s=e.length>0&&e[e.length-1].from===t.from?e[e.length-1]:null;return s?s.messages.push(t):e.push({from:t.from,messages:[t],date:t.createdAt}),e},[])}},watch:{messages(){O()},async searchContact(){clearTimeout(this.delayTimer),this.delayTimer=setTimeout(()=>{this.initialize()},600)}}},aa=b("mdi-whatsapp"),sa=b("Whatsapp"),oa=b("mdi-instagram"),la=b("Instagram"),ra=b("mdi-facebook-messenger"),ia=b("Messenger"),na={class:"pa-5 border-bottom"},da={key:1,class:""},ua=["onClick"],ca=["src"],ma={class:"msg-detail"},ha={class:"msg-username"},fa={class:"msg-content"},pa={class:"msg-message"},ga={class:"msg-date"},va={class:"d-flex pa-4 align-center"},_a=["src"],ba={class:"user-about"},ya=o("span",null,"Tooltip",-1),Ca={class:"chat-room pa-4"},Ia={class:"chat-msg-profile"},Ma=["src"],wa={class:"chat-msg-date"},Sa={class:"chat-msg-content"},Da=["innerHTML"],La={key:1,class:"chat-msg-text"},Ta=["src"],xa={key:2,class:"chat-msg-text"},Aa={key:3,class:"chat-msg-text"},Pa=o("i",{class:"mr-2 mdi text-h5 mdi-file"},null,-1),Fa=["href"],ka={class:"chat-area-footer"},Va=o("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-image"},[o("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),o("circle",{cx:"8.5",cy:"8.5",r:"1.5"}),o("path",{d:"M21 15l-5-5L5 21"})],-1),Na=o("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-plus-circle"},[o("circle",{cx:"12",cy:"12",r:"10"}),o("path",{d:"M12 8v8M8 12h8"})],-1),Ea=o("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-paperclip"},[o("path",{d:"M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"})],-1),Ra=o("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-smile"},[o("circle",{cx:"12",cy:"12",r:"10"}),o("path",{d:"M8 14s1.5 2 4 2 4-2 4-2M9 9h.01M15 9h.01"})],-1),Ba=o("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-thumbs-up"},[o("path",{d:"M14 9V5a3 3 0 00-3-3l-4 9v11h11.28a2 2 0 002-1.7l1.38-9a2 2 0 00-2-2.3zM7 22H4a2 2 0 01-2-2v-7a2 2 0 012-2h3"})],-1),Oa={key:1,id:"content_section",class:"d-flex justify-center h-100 align-center"},Ua=o("h4",null,"Start conversation",-1),ja=[Ua],Ha=b(" mdi-account "),Wa={style:{"background-color":"#ffffff"},class:"mb-7"},za=o("h3",{class:"title text-h6"},"Usuario",-1),Xa=b("Etiquetas"),qa={class:"mt-4"},Ya=b("Guardar");function Ga(e,t,s,u,a,r){const i=L("InfiniteScroll"),y=L("AgentsSelector"),m=L("perfect-scrollbar"),w=L("BaseLeftRightPartVue"),S=L("bold"),M=L("TodofullLabelsSelector");return c(),F(te,null,{default:n(()=>[l(ae,{cols:"12",sm:"9"},{default:n(()=>[l(re,null,{default:n(()=>[l(w,null,{channels:n(()=>[l(k,{small:"",onClick:t[0]||(t[0]=d=>r.addPlatform("whatsapp")),class:D({"ma-2":!0,selected:a.activePlatforms.includes("whatsapp")}),text:"",icon:"",color:"white"},{default:n(()=>[l(j,{class:"whatsapp-color"},{default:n(()=>[aa]),_:1}),l(H,{activator:"parent",anchor:"bottom"},{default:n(()=>[sa]),_:1})]),_:1},8,["class"]),l(k,{small:"",onClick:t[1]||(t[1]=d=>r.addPlatform("instagram")),class:D({"ma-2":!0,selected:a.activePlatforms.includes("instagram")}),text:"",icon:"",color:"white"},{default:n(()=>[l(j,{class:"instagram-color"},{default:n(()=>[oa]),_:1}),l(H,{activator:"parent",anchor:"bottom"},{default:n(()=>[la]),_:1})]),_:1},8,["class"]),l(k,{small:"",onClick:t[2]||(t[2]=d=>r.addPlatform("facebook")),class:D({"ma-2":!0,selected:a.activePlatforms.includes("facebook")}),text:"",icon:"",color:"white"},{default:n(()=>[l(j,{class:"messenger-color"},{default:n(()=>[ra]),_:1}),l(H,{activator:"parent",anchor:"bottom"},{default:n(()=>[ia]),_:1})]),_:1},8,["class"])]),leftpart:n(()=>[o("div",na,[l(V,{label:"Buscar contacto",variant:"outlined",density:"compact","hide-details":"",modelValue:a.searchContact,"onUpdate:modelValue":t[3]||(t[3]=d=>a.searchContact=d)},null,8,["modelValue"])]),l(Te,null,{default:n(()=>[a.isDataReady?(c(),f("div",da,[(c(),F(i,{key:a.updateScroll,onLoadMore:r.loadMore},{default:n(()=>[(c(!0),f(E,null,W(r.filteredChats,(d,h)=>(c(),f("div",{class:D({msg:!0,online:!0,"chat-active":a.selectedChat&&d._id==a.selectedChat._id}),key:h,onClick:()=>r.selectChat(d)},[o("img",{class:"msg-profile",src:r.getProfilePic(d)||"/assets/images/users/3.jpg",width:"45",alt:""},null,8,ca),o("div",ma,[o("div",ha,[o("i",{class:D(`mr-2 mdi text-h7 ${r.getPlatformIconStyle(d.platform)}`)},null,2),b(" "+_(r.getChatUserName(d)),1)]),o("div",fa,[o("span",pa,_(d.lastMessage?d.lastMessage.text:""),1),o("span",ga,_(r.formatDate(d.updatedAt,"HH:mm")),1)])])],10,ua))),128))]),_:1},8,["onLoadMore"]))])):(c(),F(se,{key:0,class:"v-progress-linear",indeterminate:"",color:"primary"}))]),_:1})]),rightpart:n(()=>{var d,h,C,R;return[a.selectedChat?(c(),f(E,{key:0},[o("div",va,[l(xe,{size:"45",class:"mr-3"},{default:n(()=>[o("img",{src:r.getProfilePic(a.selectedChat)||"/assets/images/users/3.jpg",width:"45"},null,8,_a)]),_:1}),o("div",ba,[o("h4",null,[o("i",{class:D(`mr-2 mdi text-h7 ${r.getPlatformIconStyle(a.selectedChat.platform)}`)},null,2),b(" "+_(r.getChatUserName(a.selectedChat)),1)])]),l(Ae),l(H,{top:""},{activator:n(({on:v,attrs:p})=>[l(k,Pe(p,Fe(v),{onClick:t[4]||(t[4]=Y=>a.selectedChat.isBotActive?r.connectAgent(a.selectedChat):r.endConversation(a.selectedChat)),icon:"mdi-robot",color:a.selectedChat.isBotActive?"success":"error"}),null,16,["color"])]),default:n(()=>[ya]),_:1}),l(y,{telefonoId:a.selectedChat.cleanLeadId?(h=(d=a.selectedChat.cleanLeadId)==null?void 0:d.telefonoId)==null?void 0:h._id:(R=(C=a.selectedChat.leadId)==null?void 0:C.telefonoId)==null?void 0:R._id,onOnSelectedAgent:r.onSelectedAgent},null,8,["telefonoId","onOnSelectedAgent"])]),l(oe),o("div",Ca,[X(l(se,{class:"v-progress-linear",indeterminate:"",color:"primary"},null,512),[[$,!a.isChatMessageReady]]),X(l(m,{class:"chat-room-box-height",id:"content_section"},{default:n(()=>[(c(!0),f(E,null,W(r.formattedMessages,v=>(c(),f("div",{key:v._id,class:D({"chat-msg":!0,owner:v.from!="Cliente"})},[o("div",Ia,[o("img",{class:"chat-msg-img",src:v.from=="Chatbot"?"/assets/images/users/bot.jpg":v.from=="Agente"?"/assets/images/users/3.jpg":r.getProfilePic(a.selectedChat)||"/assets/images/users/3.jpg",alt:""},null,8,Ma),o("div",wa,_(r.formatDate(v.date)),1)]),o("div",Sa,[(c(!0),f(E,null,W(v.messages,p=>(c(),f("div",{class:"mb-2",key:p._id},[p.type==="text"||!p.type?(c(),f("div",{key:0,class:"chat-msg-text",innerHTML:r.parseMarkdown(p.text)},null,8,Da)):N("",!0),p.type==="image"?(c(),f("div",La,[o("img",{src:p.payload.url},null,8,Ta)])):N("",!0),p.type==="template"?(c(),f("div",xa,[l(te,{justify:"center"},{default:n(()=>[o("div",null,[l(Be,{class:"rounded-corners",src:p.payload.product.elements[0].image_url,"aspect-ratio":"1",contain:""},null,8,["src"]),l(re,{color:"#F0F2F5",outlined:"",class:"pa-3",width:"200"},{default:n(()=>[o("strong",null,_(p.payload.product.elements[0].title),1),o("p",null,_(p.payload.product.elements[0].subtitle),1)]),_:2},1024)])]),_:2},1024)])):N("",!0),p.type==="file"?(c(),f("div",Aa,[Pa,o("a",{target:"_blank",href:p.payload.url},_(r.getFileNameFromUrl(p.payload.url)),9,Fa)])):N("",!0)]))),128))])],2))),128))]),_:1},512),[[$,a.isChatMessageReady]])]),o("div",ka,[Va,Na,Ea,l(le,{modelValue:a.text,"onUpdate:modelValue":t[5]||(t[5]=v=>a.text=v),class:"mx-1",name:"input-4-1",rows:"2",variant:"outlined","hide-details":"","no-resize":"",onKeyup:t[6]||(t[6]=ke(v=>r.sendTextMessage(a.text),["enter"])),label:a.selectedChat.isBotActive?"Desactiva el chatbot para intervenir chat":"Escribe y presiona Enter",disabled:a.selectedChat.isBotActive},null,8,["modelValue","label","disabled"]),Ra,Ba])],64)):(c(),f("div",Oa,ja))]}),_:1})]),_:1})]),_:1}),a.selectedChat?(c(),F(ae,{key:0,cols:"12",sm:"3"},{default:n(()=>[l(Ee,{elevation:"6"},{default:n(()=>[l(Ve,{modelValue:a.tabForm,"onUpdate:modelValue":t[7]||(t[7]=d=>a.tabForm=d),"background-color":"primary",class:"d-flex align-center"},{default:n(()=>[l(Ne,{value:0},{default:n(()=>[l(j,{class:"mb-1",start:""},{default:n(()=>[Ha]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}),l(Re,{modelValue:a.tabForm,"onUpdate:modelValue":t[13]||(t[13]=d=>a.tabForm=d)},{default:n(()=>[l(Q,{value:0},{default:n(()=>[o("div",Wa,[l(ie,{class:"pa-5 border-bottom"},{default:n(()=>[za,o("h4",null," Fuente: "+_(e.$store.state.botsModule.bots.find(d=>d.fanpageId==a.selectedChat.pageID)?e.$store.state.botsModule.bots.find(d=>d.fanpageId==a.selectedChat.pageID).name:"Sin fuente"),1)]),_:1}),l(oe),l(ie,{class:"pa-5 border-bottom"},{default:n(()=>[l(V,{dense:"",outlined:"",label:"Nombres",placeholder:"Username","append-icon":"mdi-account",modelValue:a.userForm.name,"onUpdate:modelValue":t[8]||(t[8]=d=>a.userForm.name=d)},null,8,["modelValue"]),l(V,{dense:"",outlined:"",label:"Tel\xE9fonos",placeholder:"Username","append-icon":"mdi-cellphone",modelValue:a.userForm.phone,"onUpdate:modelValue":t[9]||(t[9]=d=>a.userForm.phone=d)},null,8,["modelValue"]),l(V,{dense:"",outlined:"",label:"Correo",placeholder:"Email","append-icon":"mdi-email",modelValue:a.userForm.email,"onUpdate:modelValue":t[10]||(t[10]=d=>a.userForm.email=d)},null,8,["modelValue"]),l(V,{dense:"",outlined:"",label:"Ciudad",placeholder:"Email","append-icon":"mdi-email",modelValue:a.userForm.city,"onUpdate:modelValue":t[11]||(t[11]=d=>a.userForm.city=d)},null,8,["modelValue"]),l(le,{clearable:"","clear-icon":"mdi-close-circle",label:"Notas",modelValue:a.userForm.notes,"onUpdate:modelValue":t[12]||(t[12]=d=>a.userForm.notes=d)},null,8,["modelValue"]),l(S,null,{default:n(()=>[Xa]),_:1}),(c(),F(M,{initialData:a.userForm.todofullLabels,class:"ma-3",onOnSelectTodofullLabels:r.onSelectTodofullLabels,key:a.updateLabels},null,8,["initialData","onOnSelectTodofullLabels"])),o("div",qa,[l(k,{color:"success",onClick:r.saveUserForm,outlined:"",class:"text-capitalize mr-2"},{default:n(()=>[Ya]),_:1},8,["onClick"])])]),_:1})])]),_:1}),l(Q,{value:1}),l(Q,{value:2})]),_:1},8,["modelValue"])]),_:1})):N("",!0)]),_:1})}var Za=q(ta,[["render",Ga]]);export{Za as default};
